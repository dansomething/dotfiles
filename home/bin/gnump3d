#!/usr/bin/env groovy

@Grapes([
    @Grab('org.jsoup:jsoup:1.3.1')
])
import org.jsoup.Jsoup

def download(url)
{
	def fileName = url.tokenize("/")[-1]
    def file = new FileOutputStream(fileName)
    def out = new BufferedOutputStream(file)
    out << new URL(url).openStream()
    out.close()

	fileName
}

println "Ctrl+C to exit"

def read = System.in.newReader().&readLine

while (true) {
	def doc = Jsoup.connect("http://gnump3d:8889/random/directory").timeout(10*1000).get()
	def aTags = doc.select("#content p a")
	
	def url = aTags[3].absUrl("href")
	if (url.contains(".AppleDouble")) continue

	def artist = aTags[1].text() 
	def album = aTags[2].text()

	println "Play? $artist - $album - $url"
	print "(y/N): "
	input = read().toLowerCase()
    
	if (input == "y") {
		println "Downloading $url..."
		def fileName = download(url)
		println "Playing $artist - $album..."
		"open -a iTunes $fileName".execute().in.eachLine { println it }
		sleep(1*1000)
		//println "Removing $fileName..."
		new File(fileName).delete()
	}
}
