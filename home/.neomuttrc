# Mail Access
# ----------------------------------------------------

source ~/.mutt/credentials.muttrc

set use_from = yes
set envelope_from = yes

set imap_keepalive = 900
set smtp_authenticators = "gssapi:login"

# Ensure TLS is enforced
set ssl_starttls = yes
set ssl_force_tls = yes

# Imap Gmail
set folder = "imaps://imap.gmail.com"
set spoolfile = "+INBOX""
set record = "+[Gmail]/Sent Mail"
set postponed = "+[Gmail]/Drafts"
set trash = '+[Gmail]/Trash'

# Directories
set header_cache = "~/.mutt/cache/headers"
set message_cachedir = "~/.mutt/cache/bodies"
set certificate_file = "~/.mutt/certificates"
set move = no

# UI
# ----------------------------------------------------
source ~/.mutt/colors/solarized-dark-256.muttrc

set editor = "vim"
set charset = "utf-8"

set timeout = 30
# https://www.neomutt.org/guide/reference search sleep_time for additional info
set sleep_time = 0 # be faster
set beep = no
# set editor = "/Applications/MacVim.app/Contents/MacOS/Vim -c 'set tw = 74' -c 'set wrap'"
auto_view text/html
# set sort = reverse-date   # default sorting by date
set sort = "threads"
set strict_threads = "yes"
set sort_browser = "reverse-date"
unset collapse_unread
# When sorting by threads, this variable controls how threads are sorted
# in relation to other threads, and how the branches of the thread trees are sorted.
set sort_aux = "last-date-received"
# Index page format. Default "%4C %Z %{%b %d} %-15.15L (%?l?%4l&%4c?) %s"
set index_format = "%4C %Z %{%b %d %R} %-15.15L (%?l?%4l&%4c?) %s"

set sidebar_visible
set sidebar_format = "%B%?F? [%F]?%* %?N?%N/?%S"
set mail_check_stats

# https://neomutt.org/feature/new-mail
set new_mail_command = "terminal-notifier -title '%v' -subtitle 'New Mail' \
-message '%n new messages, %u unread.' -activate 'com.googlecode.iterm2' -sound 'new mail'"

# You can use any gmail imap mailboxes
mailboxes =INBOX =[Gmail]/Sent\ Mail =[Gmail]/Drafts =[Gmail]/Spam =[Gmail]/Trash

# Navigation
# ----------------------------------------------------

bind generic             z         noop
bind index,pager,attach  g         noop
bind index,pager         d         noop
bind index,pager         s         noop
bind index,pager         c         noop
bind generic,pager       t         noop

bind generic,index,pager \Cf       next-page
bind generic,index,pager \Cb       previous-page
bind generic             gg        first-entry
bind attach,index        g         first-entry
bind generic,index       G         last-entry
bind attach,index        G         last-entry
bind pager               gg        top
bind pager               G         bottom
bind generic,pager       \Cy       previous-line
bind generic,index,pager \Ce       next-line
bind generic,index,pager \Cd       half-down
bind generic,index,pager \Cu       half-up
bind generic             zt        current-top
bind generic             zz        current-middle
bind generic             zb        current-bottom
bind index               za        collapse-thread
bind index               zA        collapse-all
bind index,pager         N         search-opposite
bind index               <Backtab> previous-new-then-unread

# Go to folder...
macro index,pager gi "<change-folder>=INBOX<enter>"                 "open inbox"
macro index,pager gd "<change-folder>=[Gmail]/Drafts<enter>"        "open drafts"
macro index,pager gs "<change-folder>=[Gmail]/Sent%20Mail<enter>"   "open sent"
macro index,pager gt "<change-folder>$trash<enter>"                 "open trash"
macro index,pager gf "<change-folder>?"                             "open mailbox..."

# Actions
# ----------------------------------------------------

bind  index,pager    a   group-reply
macro index,pager    dd  "<delete-message><sync-mailbox>y"                                "move message to trash"
macro index,pager    dat "<delete-thread><sync-mailbox>"                                  "move thread to trash"
macro index,pager    ss  ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015<save-message>?"                                                                                                                                     "save message to a mailbox"
macro index          sat ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015'q<untag-pattern>.\\015\"\015<mark-message>q<enter><untag-pattern>.<enter><tag-thread><tag-prefix-cond><save-message>?"                                    "save thread to a mailbox"
macro index          \;s ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015<tag-prefix-cond><save-message>?"                                                                                                                    "save tagged messages to a mailbox"
macro pager          sat ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015<display-message>\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015'q<untag-pattern>.\\015<display-message>\"\015<exit><mark-message>q<enter><untag-pattern>.<enter><tag-thread><tag-prefix><save-message>?" "save thread to a mailbox"
macro index,pager    cc  ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015<copy-message>?"                                                                                                                                     "copy message to a mailbox"
macro index          cat ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015'q<untag-pattern>.\\015\"\015<mark-message>q<enter><untag-pattern>.<enter><tag-thread><tag-prefix-cond><copy-message>?"                                    "copy thread to a mailbox"
macro index          \;c ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015\"\015<tag-prefix-cond><copy-message>?"                                                                                                                    "copy tagged messages to a mailbox"
macro pager          cat ":macro browser \\015 \"\<select-entry\>\<sync-mailbox\>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015<display-message>\"\015:macro browser q \"<exit>:bind browser \\\\015 select-entry\\015:bind browser q exit\\015'q<untag-pattern>.\\015<display-message>\"\015<exit><mark-message>q<enter><untag-pattern>.<enter><tag-thread><tag-prefix><copy-message>?" "copy thread to a mailbox"
bind  generic        tt  tag-entry
bind  index          tat tag-thread
bind  pager          tt  tag-message
macro pager          tat "<exit><mark-message>q<enter><tag-thread>'q<display-message>"    "tag-thread"
macro index,pager    gx  "<pipe-message>urlview<Enter>"                                   "call urlview to extract URLs out of a message"
macro attach,compose gx  "<pipe-entry>urlview<Enter>"                                     "call urlview to extract URLs out of a message"

# Command Line
# ----------------------------------------------------

bind editor \Cp history-up
bind editor \Cn history-down


# Sidebar
# ----------------------------------------------------

bind index,pager \CP sidebar-prev                 # Ctrl-n to select next folder
bind index,pager \CN sidebar-next                 # Ctrl-p to select previous folder
bind index,pager \CI sidebar-open                 # Ctrl-o to open selected folder
bind index,pager \CB sidebar-toggle-visible       # Ctrl-b to toggle visibility of the sidebar

# Threads
# ----------------------------------------------------

bind index - collapse-thread
bind index _ collapse-all
